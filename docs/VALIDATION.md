# Validation

This document describes how to validate SPDX SBOM documents and SARIF vulnerability reports generated by BazBOM.

## SPDX Validation

### Why Validate SBOMs?

Validation ensures:
- Compliance with SPDX specification
- Interoperability with other tools
- Completeness of required fields
- Correct relationship structures

### Using SPDX Tools

#### Official SPDX Validator

Install the official SPDX validator:

```bash
# Using Maven
mvn dependency:get \
  -Dartifact=org.spdx:spdx-tools:1.1.8:jar \
  -Ddest=./spdx-tools.jar

# Validate an SBOM
java -jar spdx-tools.jar Verify bazel-bin/path/to/package.spdx.json
```

#### Built-in Validator

BazBOM includes a Python-based validator:

```bash
# Validate a single SBOM
bazel run //tools/supplychain:validate_spdx -- \
  --input bazel-bin/path/to/package.spdx.json

# Validate all SBOMs
find bazel-bin -name "*.spdx.json" -exec \
  bazel run //tools/supplychain:validate_spdx -- --input {} \;
```

### Schema Validation

Validate against the SPDX JSON schema:

```bash
# Install jsonschema CLI tool
pip install check-jsonschema

# Validate SBOM
check-jsonschema \
  --schemafile https://raw.githubusercontent.com/spdx/spdx-spec/v2.3/schemas/spdx-schema.json \
  bazel-bin/path/to/package.spdx.json
```

### Common Validation Issues

#### Missing Required Fields

**Error**: `Missing required field: dataLicense`

**Fix**: Ensure `write_sbom.py` includes all required SPDX 2.3 fields:
- `spdxVersion`
- `dataLicense`
- `SPDXID`
- `name`
- `documentNamespace`
- `creationInfo`

#### Invalid SPDX IDs

**Error**: `Invalid SPDXID format`

**Fix**: SPDX IDs must match the pattern: `SPDXRef-[A-Za-z0-9.-]+`

```python
# Correct
"SPDXID": "SPDXRef-Package-org.example-my-lib-1.0.0"

# Incorrect (contains ':')
"SPDXID": "SPDXRef-Package-org.example:my-lib:1.0.0"
```

#### Invalid Relationships

**Error**: `Relationship references non-existent SPDXID`

**Fix**: Ensure all relationships reference valid SPDX IDs:

```python
# Every relatedSpdxElement must exist in packages
{
  "spdxElementId": "SPDXRef-Package-root",
  "relationshipType": "DEPENDS_ON",
  "relatedSpdxElement": "SPDXRef-Package-dependency"  # Must exist
}
```

#### Invalid License

**Error**: `License not found in SPDX License List`

**Fix**: Use valid SPDX license identifiers or `NOASSERTION`:

```python
# Correct
"licenseDeclared": "Apache-2.0"
"licenseDeclared": "MIT"
"licenseDeclared": "NOASSERTION"

# Incorrect
"licenseDeclared": "Apache License 2.0"  # Use SPDX ID
```

## SARIF Validation

### Why Validate SARIF?

Validation ensures:
- Compatibility with GitHub Code Scanning
- Correct severity levels
- Proper result formatting
- Valid file paths

### Using SARIF Tools

#### SARIF Multitool

Install the SARIF Multitool:

```bash
# Using .NET
dotnet tool install --global Sarif.Multitool

# Validate a SARIF file
sarif validate bazel-bin/path/to/vulnerabilities.sarif.json
```

#### Built-in Validator

```bash
# Validate a single SARIF file
bazel run //tools/supplychain:validate_sarif -- \
  --input bazel-bin/path/to/vulnerabilities.sarif.json

# Validate all SARIF files
find bazel-bin -name "*.sarif.json" -exec \
  bazel run //tools/supplychain:validate_sarif -- --input {} \;
```

### Schema Validation

Validate against the SARIF JSON schema:

```bash
# Validate SARIF file
check-jsonschema \
  --schemafile https://json.schemastore.org/sarif-2.1.0.json \
  bazel-bin/path/to/vulnerabilities.sarif.json
```

### Common Validation Issues

#### Missing Required Properties

**Error**: `Missing required property: version`

**Fix**: Ensure all required SARIF properties are present:
- `version` (must be "2.1.0")
- `$schema`
- `runs` (array with at least one run)

#### Invalid Result Levels

**Error**: `Invalid result level`

**Fix**: Use only valid SARIF levels:
- `error` - Critical/High vulnerabilities
- `warning` - Medium vulnerabilities
- `note` - Low/Informational vulnerabilities

```python
# Correct
"level": "error"

# Incorrect
"level": "critical"  # Not a valid SARIF level
```

#### Invalid URIs

**Error**: `Invalid artifact URI`

**Fix**: URIs should be relative to repository root:

```python
# Correct
"artifactLocation": {
  "uri": "pom.xml"
}

# Incorrect (absolute path)
"artifactLocation": {
  "uri": "/home/user/project/pom.xml"
}
```

## Automated Validation in CI

### GitHub Actions Workflow

Add validation to your CI pipeline:

```yaml
# .github/workflows/validate.yml
name: Validate SBOM and SARIF

on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.8.1
        with:
          bazelisk-cache: true
      
      - name: Generate SBOMs
        run: bazel build //:sbom_all
      
      - name: Validate SBOMs
        run: |
          find bazel-bin -name "*.spdx.json" | while read sbom; do
            bazel run //tools/supplychain:validate_spdx -- --input "$sbom"
          done
      
      - name: Run SCA
        run: bazel run //:sca_from_sbom
      
      - name: Validate SARIF
        run: |
          find bazel-bin -name "*.sarif.json" | while read sarif; do
            bazel run //tools/supplychain:validate_sarif -- --input "$sarif"
          done
```

### Pre-commit Hook

Add validation to pre-commit:

```bash
# tools/dev/pre-commit.sh
#!/bin/bash

echo "Validating SBOMs..."
bazel build //:sbom_all

for sbom in $(find bazel-bin -name "*.spdx.json"); do
  echo "Validating $sbom"
  bazel run //tools/supplychain:validate_spdx -- --input "$sbom" || exit 1
done

echo "Running SCA..."
bazel run //:sca_from_sbom

for sarif in $(find bazel-bin -name "*.sarif.json"); do
  echo "Validating $sarif"
  bazel run //tools/supplychain:validate_sarif -- --input "$sarif" || exit 1
done

echo "All validations passed!"
```

## NTIA Minimum Elements

Validate SBOM completeness against NTIA requirements:

### Required Fields

Per [NTIA Minimum Elements](https://www.ntia.gov/report/2021/minimum-elements-software-bill-materials-sbom):

1. **Supplier Name** - `supplier` or `originator`
2. **Component Name** - `name`
3. **Version** - `versionInfo`
4. **Other Unique IDs** - `externalRefs` with purl
5. **Dependency Relationships** - `relationships`
6. **SBOM Author** - `creationInfo.creators`
7. **Timestamp** - `creationInfo.created`

### Validation Script

```bash
# Check NTIA compliance
bazel run //tools/supplychain:validate_ntia -- \
  --input bazel-bin/path/to/package.spdx.json
```

## Best Practices

### 1. Validate on Every Build

```bash
bazel build //:sbom_all && bazel run //tools/supplychain:validate_all
```

### 2. Store Validation Reports

```bash
# Generate validation report
bazel run //tools/supplychain:validate_spdx -- \
  --input package.spdx.json \
  --report validation-report.txt
```

### 3. Fail Fast in CI

```yaml
- name: Validate
  run: bazel run //tools/supplychain:validate_all
  # Exit on first failure
```

### 4. Version Control Validated SBOMs

Only commit SBOMs that pass validation:

```bash
# .github/workflows/release.yml
- name: Validate and Commit SBOM
  run: |
    bazel build //:release_sbom
    bazel run //tools/supplychain:validate_spdx -- \
      --input bazel-bin/release.spdx.json
    cp bazel-bin/release.spdx.json release/
    git add release/release.spdx.json
```

## Troubleshooting

### Validation Errors in CI

If validation fails in CI but passes locally:

1. Check Bazel version consistency
2. Verify network access (for schema downloads)
3. Ensure all build outputs are committed
4. Check for filesystem case sensitivity issues

### Large SBOM Files

For projects with many dependencies:

```bash
# Validate in parallel
find bazel-bin -name "*.spdx.json" | \
  xargs -P 4 -I {} bazel run //tools/supplychain:validate_spdx -- --input {}
```

### Schema Version Mismatches

If using a newer SPDX version:

```python
# Update schema URL in validator
SPDX_SCHEMA_URL = "https://raw.githubusercontent.com/spdx/spdx-spec/v2.3.1/schemas/spdx-schema.json"
```

## References

- [SPDX 2.3 Specification](https://spdx.github.io/spdx-spec/v2.3/)
- [SARIF 2.1.0 Specification](https://docs.oasis-open.org/sarif/sarif/v2.1.0/sarif-v2.1.0.html)
- [NTIA SBOM Minimum Elements](https://www.ntia.gov/report/2021/minimum-elements-software-bill-materials-sbom)
- [SPDX Tools](https://github.com/spdx/tools)
- [SARIF Multitool](https://github.com/microsoft/sarif-sdk)
