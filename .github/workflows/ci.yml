name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Default permissions following PYSEC_OMEGA standards
permissions:
  contents: read

# Prevent concurrent runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    permissions:
      contents: read
      checks: write  # For test result annotations
    
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false
      
      - name: Setup Java
        uses: actions/setup-java@de5a937a1dc73fbc1a67d7d1aa4bebc1082f3190 # v4.7.0
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'
      
      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@e403ad507104847c3539436a14f16b779aa17af5 # v0.8.1
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true
      
      - name: Build all targets
        run: bazel build //...
        timeout-minutes: 30
      
      - name: Run tests
        run: bazel test //... --test_output=errors
        timeout-minutes: 20
      
      - name: Build examples
        run: bazel build //examples/...
        timeout-minutes: 10
  
  lint-docs:
    name: Lint Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false
      
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install markdownlint
        run: npm install -g markdownlint-cli
      
      - name: Lint markdown files
        run: markdownlint --config .markdownlint.json docs/**/*.md *.md security/**/*.md
  
  validate-bazel:
    name: Validate Bazel Files
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: false
      
      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@e403ad507104847c3539436a14f16b779aa17af5 # v0.8.1
        with:
          bazelisk-cache: true
      
      - name: Validate WORKSPACE
        run: bazel query //... > /dev/null
        timeout-minutes: 5
      
      - name: Check formatting (buildifier)
        run: |
          # Install buildifier with version pinning
          BUILDIFIER_VERSION="6.4.0"
          BUILDIFIER_SHA256="be63db12899f48600bad94051123b1fd7b5251e7661b9168582ce52396132e92"
          
          wget -O /tmp/buildifier "https://github.com/bazelbuild/buildtools/releases/download/v${BUILDIFIER_VERSION}/buildifier-linux-amd64"
          echo "${BUILDIFIER_SHA256}  /tmp/buildifier" | sha256sum -c
          chmod +x /tmp/buildifier
          sudo mv /tmp/buildifier /usr/local/bin/buildifier
          
          # Check formatting
          buildifier -mode=check -r .
        timeout-minutes: 5
