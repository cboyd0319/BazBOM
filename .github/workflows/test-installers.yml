name: Test Installers (Integration)

on:
  pull_request:
    paths:
      - 'install.sh'
      - 'scripts/package-local-build.sh'
      - 'scripts/generate-homebrew-formula.sh'
      - '.github/workflows/release.yml'
      - '.github/workflows/build-installers.yml'
      - '.github/workflows/test-installers.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-install-script:
    name: Test install.sh on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build binary
        run: |
          cargo build --release -p bazbom

      - name: Package binary
        run: |
          ./scripts/package-local-build.sh

      - name: Create mock release server
        run: |
          # Get version
          VERSION=$(cargo pkgid -p bazbom | cut -d'#' -f2)

          # Set up mock release structure
          mkdir -p /tmp/mock-release/releases/download/v${VERSION}
          cp dist/*.tar.gz /tmp/mock-release/releases/download/v${VERSION}/

          # Create mock API response
          cat > /tmp/mock-release/releases/latest << EOF
          {
            "tag_name": "v${VERSION}",
            "name": "v${VERSION}",
            "draft": false,
            "prerelease": false
          }
          EOF

          # Start server in background
          cd /tmp/mock-release
          python3 -m http.server 8888 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          cd -

          # Wait for server to start
          sleep 2

      - name: Test install script with mock server
        run: |
          VERSION=$(cargo pkgid -p bazbom | cut -d'#' -f2)

          # Create test install script pointing to mock server
          sed "s|https://github.com/cboyd0319/BazBOM|http://localhost:8888|g" install.sh | \
            sed "s|https://api.github.com/repos/cboyd0319/BazBOM|http://localhost:8888|g" > /tmp/test-install.sh
          chmod +x /tmp/test-install.sh

          # Test installation
          TEST_DIR=/tmp/bazbom-test-install
          mkdir -p $TEST_DIR
          INSTALL_DIR=$TEST_DIR VERSION=$VERSION bash /tmp/test-install.sh

          # Verify installation
          if [ -f "$TEST_DIR/bazbom" ]; then
            echo "✓ Binary installed successfully"
            $TEST_DIR/bazbom --version
            $TEST_DIR/bazbom --help > /dev/null
            echo "✓ Binary is functional"
          else
            echo "✗ Binary not found after installation"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi

  test-package-script:
    name: Test package-local-build.sh
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build binary
        run: |
          cargo build --release -p bazbom

      - name: Test packaging script
        run: |
          ./scripts/package-local-build.sh

          # Verify package was created
          if ls dist/bazbom-*.tar.gz 1> /dev/null 2>&1; then
            echo "✓ Package created"
          else
            echo "✗ Package not created"
            exit 1
          fi

          # Verify checksum was created
          if ls dist/bazbom-*.tar.gz.sha256 1> /dev/null 2>&1; then
            echo "✓ Checksum file created"
          else
            echo "✗ Checksum file not created"
            exit 1
          fi

          # Verify checksum is valid
          cd dist
          sha256sum -c *.sha256
          cd -
          echo "✓ Checksum is valid"

          # Test extraction
          mkdir -p /tmp/test-extract
          tar -xzf dist/bazbom-*.tar.gz -C /tmp/test-extract
          if [ -f /tmp/test-extract/bazbom ]; then
            echo "✓ Binary can be extracted"
            /tmp/test-extract/bazbom --version
            echo "✓ Extracted binary is functional"
          else
            echo "✗ Binary not found after extraction"
            exit 1
          fi

  test-homebrew-formula-generation:
    name: Test Homebrew formula generation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          cargo build --release -p bazbom

      - name: Test formula generation (mock)
        run: |
          VERSION=$(cargo pkgid -p bazbom | cut -d'#' -f2)

          # Test that the script runs without errors
          # Note: This will fail to download real releases, but tests the script logic
          ./scripts/generate-homebrew-formula.sh $VERSION || true

          # Check that the script created the expected output location
          if [ -d /tmp/bazbom-checksums ]; then
            echo "✓ Script created working directory"
            if [ -f /tmp/bazbom-checksums/Formula-bazbom.rb ]; then
              echo "✓ Formula file generated"
              cat /tmp/bazbom-checksums/Formula-bazbom.rb
            else
              echo "⚠ Formula file not generated (expected without real release)"
            fi
          else
            echo "⚠ Working directory not created (expected behavior)"
          fi

  test-makefile:
    name: Test Makefile targets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test make help
        run: make help

      - name: Test make build
        run: make build

      - name: Test make package
        run: make package

      - name: Verify package created
        run: |
          ls -lh dist/
          if ls dist/bazbom-*.tar.gz 1> /dev/null 2>&1; then
            echo "✓ Package created via Makefile"
          else
            echo "✗ Package not created"
            exit 1
          fi

  integration-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [test-install-script, test-package-script, test-homebrew-formula-generation, test-makefile]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Installer Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Install Script | ${{ needs.test-install-script.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Script | ${{ needs.test-package-script.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Homebrew Formula | ${{ needs.test-homebrew-formula-generation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Makefile | ${{ needs.test-makefile.result }} |" >> $GITHUB_STEP_SUMMARY

