name: Workflow Status Dashboard

# Update a pinned issue with real-time workflow status overview

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]
  schedule:
    # Refresh dashboard every hour
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  update-dashboard:
    name: Update Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Generate workflow status dashboard
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get all workflows
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner,
              repo
            });

            // Get recent runs for each workflow
            const workflowStatuses = [];

            for (const workflow of workflows.workflows) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                per_page: 10
              });

              const recentRun = runs.workflow_runs[0];
              if (!recentRun) continue;

              const status = recentRun.conclusion === 'success' ? 'âœ…' :
                            recentRun.conclusion === 'failure' ? 'âŒ' :
                            recentRun.conclusion === 'cancelled' ? 'ðŸš«' :
                            'â¸ï¸';

              workflowStatuses.push({
                name: workflow.name,
                status,
                conclusion: recentRun.conclusion,
                url: recentRun.html_url,
                updated: recentRun.updated_at,
                branch: recentRun.head_branch
              });
            }

            // Sort by name
            workflowStatuses.sort((a, b) => a.name.localeCompare(b.name));

            // Calculate statistics
            const total = workflowStatuses.length;
            const success = workflowStatuses.filter(w => w.conclusion === 'success').length;
            const failures = workflowStatuses.filter(w => w.conclusion === 'failure').length;
            const successRate = total > 0 ? ((success / total) * 100).toFixed(1) : 0;

            // Generate dashboard content
            const dashboardBody = `# ðŸ”„ CI/CD Workflow Status Dashboard

            > **Last updated:** ${new Date().toUTCString()}
            > **Success rate:** ${successRate}% (${success}/${total})

            ## Workflow Status Overview

            | Workflow | Status | Last Run | Branch |
            |----------|--------|----------|--------|
            ${workflowStatuses.map(w => {
              const timeAgo = new Date(w.updated).toLocaleDateString();
              return `| [${w.name}](${w.url}) | ${w.status} | ${timeAgo} | \`${w.branch || 'N/A'}\` |`;
            }).join('\n')}

            ## Legend
            - âœ… Success
            - âŒ Failure
            - ðŸš« Cancelled
            - â¸ï¸  Other

            ## Quick Links
            - [All Workflows](https://github.com/${owner}/${repo}/actions)
            - [Recent Runs](https://github.com/${owner}/${repo}/actions?query=is%3Acompleted)
            - [Failed Runs](https://github.com/${owner}/${repo}/actions?query=is%3Afailure)

            ---
            *This dashboard is automatically updated by the workflow-status-dashboard workflow*
            `;

            // Find or create dashboard issue
            const dashboardTitle = 'ðŸ“Š CI/CD Workflow Status Dashboard';

            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'dashboard',
              per_page: 100
            });

            const dashboardIssue = issues.find(issue =>
              issue.title === dashboardTitle
            );

            if (dashboardIssue) {
              // Update existing dashboard
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: dashboardIssue.number,
                body: dashboardBody
              });
              console.log(`Updated dashboard issue #${dashboardIssue.number}`);
            } else {
              // Create new dashboard issue
              const { data: newIssue } = await github.rest.issues.create({
                owner,
                repo,
                title: dashboardTitle,
                body: dashboardBody,
                labels: ['dashboard', 'pinned']
              });

              // Pin the issue (note: requires manual pinning via UI)
              console.log(`Created new dashboard issue #${newIssue.number}`);
              console.log('Please pin this issue manually in the GitHub UI');
            }

            // Log summary
            console.log(`Dashboard updated: ${success}/${total} workflows passing (${successRate}%)`);
