name: Dependency Review

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Restrict permissions following PYSEC_OMEGA standards
permissions:
  contents: read

jobs:
  dependency-review:
    name: Dependency Security Review
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read
      pull-requests: write  # For PR comments
    
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
      
      - name: Dependency Review
        uses: actions/dependency-review-action@f30a9b4af2e5a0d6306c1e9346ce0abe35f4c1ab # v5.0.0
        with:
          # Fail on high or critical vulnerabilities
          fail-on-severity: high
          
          # Block GPL licenses (if configured)
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0
          
          # Allow common permissive licenses
          allow-licenses: Apache-2.0, MIT, BSD-2-Clause, BSD-3-Clause, ISC
          
          # Comment on PRs with findings
          comment-summary-in-pr: always
          
          # Show detailed vulnerability information
          vulnerability-check: true
          
          # Check license compatibility
          license-check: true
          
          # Warn on deprecated packages
          warn-on-openssf-scorecard-level: 3
      
      - name: Upload dependency graph
        uses: actions/upload-artifact@84480863f228bb9747b473957fcc9e309aa96097 # v4.4.2
        if: always()
        with:
          name: dependency-review-graph
          path: dependency-graph.json
          retention-days: 30
          if-no-files-found: warn

  cargo-audit:
    name: Cargo Audit - Rust Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        run: cargo audit --json > audit-results.json
        continue-on-error: true

      - name: Check for vulnerabilities
        run: |
          if cargo audit --deny warnings; then
            echo "âœ… No vulnerabilities found in Cargo dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Vulnerabilities found - review audit-results.json" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@84480863f228bb9747b473957fcc9e309aa96097 # v4.4.2
        if: always()
        with:
          name: cargo-audit-results
          path: audit-results.json
          retention-days: 30
          if-no-files-found: warn

  cargo-lock-verification:
    name: Verify Cargo.lock is Up-to-Date
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Cargo.lock is up-to-date
        run: |
          echo "## Cargo.lock Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f "Cargo.lock" ]; then
            echo "âŒ Cargo.lock not found (required for reproducible builds)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Check if Cargo.lock is up-to-date with Cargo.toml files
          cargo update --workspace --dry-run > /tmp/cargo-check.txt 2>&1

          if grep -q "Updating" /tmp/cargo-check.txt; then
            echo "âš ï¸ Cargo.lock is out of date" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/cargo-check.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`cargo update\` to update Cargo.lock" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Cargo.lock is up-to-date" >> $GITHUB_STEP_SUMMARY
          fi

          # Count dependencies
          local dep_count=$(grep -c "^name = " Cargo.lock || echo "0")
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Total locked dependencies: $dep_count" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Security Review Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [dependency-review, cargo-audit, cargo-lock-verification]
    if: always()

    permissions:
      contents: read

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”’ Dependency Security Review Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All dependency security checks have been executed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Dependency Review" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cargo Audit (Rust security advisories)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cargo.lock verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the individual job outputs for detailed results." >> $GITHUB_STEP_SUMMARY
