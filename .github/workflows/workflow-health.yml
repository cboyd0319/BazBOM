name: Workflow Health Monitoring

# Monitor CI health and alert if failure rates are too high

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  health-check:
    name: Check Workflow Health
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Check workflow success rates
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get recent workflow runs (last 100)
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              per_page: 100,
              status: 'completed'
            });

            // Calculate statistics
            const total = runs.workflow_runs.length;
            const failures = runs.workflow_runs.filter(run =>
              run.conclusion === 'failure'
            ).length;
            const cancelled = runs.workflow_runs.filter(run =>
              run.conclusion === 'cancelled'
            ).length;
            const success = runs.workflow_runs.filter(run =>
              run.conclusion === 'success'
            ).length;

            const failureRate = (failures / total * 100).toFixed(2);
            const successRate = (success / total * 100).toFixed(2);

            // Generate summary
            core.summary.addHeading('ðŸ¥ Workflow Health Report', 2);
            core.summary.addRaw('');
            core.summary.addTable([
              [{data: 'Metric', header: true}, {data: 'Value', header: true}],
              ['Total Runs', total.toString()],
              ['âœ… Success', `${success} (${successRate}%)`],
              ['âŒ Failures', `${failures} (${failureRate}%)`],
              ['ðŸš« Cancelled', cancelled.toString()]
            ]);
            await core.summary.write();

            // Alert if failure rate is too high (>10%)
            if (parseFloat(failureRate) > 10) {
              core.setFailed(`âŒ Workflow failure rate too high: ${failureRate}%`);

              // Create or update health issue
              const issueTitle = 'âš ï¸ High CI Failure Rate Detected';
              const issueBody = `## Workflow Health Alert

            The CI failure rate has exceeded the acceptable threshold.

            ### Current Statistics
            - **Failure Rate:** ${failureRate}%
            - **Success Rate:** ${successRate}%
            - **Total Runs Analyzed:** ${total}

            ### Recent Failures
            ${runs.workflow_runs
              .filter(run => run.conclusion === 'failure')
              .slice(0, 5)
              .map(run => `- [${run.name}](${run.html_url}) - ${new Date(run.created_at).toLocaleDateString()}`)
              .join('\n')}

            ### Action Required
            Please investigate the failing workflows and address any systemic issues.

            ---
            *This issue was automatically generated by workflow-health.yml*
            `;

              // Search for existing health issue
              const { data: issues } = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: 'open',
                labels: 'ci-health',
                per_page: 1
              });

              if (issues.length > 0) {
                // Update existing issue
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issues[0].number,
                  body: issueBody
                });
                console.log(`Updated existing health issue #${issues[0].number}`);
              } else {
                // Create new issue
                await github.rest.issues.create({
                  owner,
                  repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['ci-health', 'automated']
                });
                console.log('Created new health issue');
              }
            } else {
              console.log(`âœ… Workflow health is good: ${failureRate}% failure rate`);

              // Close health issue if it exists and health is good
              const { data: issues } = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: 'open',
                labels: 'ci-health',
                per_page: 1
              });

              if (issues.length > 0) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issues[0].number,
                  state: 'closed',
                  body: issues[0].body + `\n\n---\nâœ… **Resolved:** Workflow health has returned to normal (${failureRate}% failure rate).`
                });
                console.log(`Closed health issue #${issues[0].number}`);
              }
            }
