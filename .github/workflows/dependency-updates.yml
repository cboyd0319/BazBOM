name: Automated Dependency Updates

# Weekly automated Cargo dependency updates to stay current with security patches
#
# IMPORTANT: Repository Setting Required
# For this workflow to create pull requests, you must enable:
# Settings â†’ Actions â†’ General â†’ Workflow permissions â†’
# âœ“ "Allow GitHub Actions to create and approve pull requests"
#
# Alternative: Set a PAT_TOKEN secret with repo scope.
# See .github/WORKFLOW_SETUP.md for detailed instructions.

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  cargo-update:
    name: Update Rust Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          persist-credentials: true
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: "rust-global-${{ hashFiles('**/Cargo.lock') }}"
          save-if: false

      - name: Update Cargo dependencies
        run: |
          echo "## Updating Cargo dependencies..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Capture current versions
          cp Cargo.lock Cargo.lock.old

          # Update all dependencies to latest compatible versions
          cargo update 2>&1 | tee update-output.txt

          # Check if anything changed
          if diff Cargo.lock.old Cargo.lock > /dev/null 2>&1; then
            echo "â„¹ï¸  No dependency updates available" >> $GITHUB_STEP_SUMMARY
            echo "NO_UPDATES=true" >> $GITHUB_ENV
          else
            echo "âœ… Dependencies updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "NO_UPDATES=false" >> $GITHUB_ENV
          fi

      - name: Run tests to verify updates
        if: env.NO_UPDATES == 'false'
        run: |
          echo "Running tests with updated dependencies..."
          cargo test --workspace --all-features

      - name: Run security audit
        if: env.NO_UPDATES == 'false'
        run: |
          cargo install cargo-audit --locked || true
          cargo audit || true

      - name: Generate update summary
        if: env.NO_UPDATES == 'false'
        run: |
          echo "## ðŸ“¦ Dependency Updates" >> pr-body.md
          echo "" >> pr-body.md
          echo "This PR updates Rust dependencies to their latest compatible versions." >> pr-body.md
          echo "" >> pr-body.md
          echo "### Changes" >> pr-body.md
          echo "\`\`\`" >> pr-body.md
          cat update-output.txt >> pr-body.md
          echo "\`\`\`" >> pr-body.md
          echo "" >> pr-body.md
          echo "### Verification" >> pr-body.md
          echo "- âœ… All tests pass with updated dependencies" >> pr-body.md
          echo "- âœ… Security audit completed" >> pr-body.md
          echo "" >> pr-body.md
          echo "### Review Notes" >> pr-body.md
          echo "Please review the changelog for each updated dependency to ensure no breaking changes." >> pr-body.md
          echo "" >> pr-body.md
          echo "---" >> pr-body.md
          echo "*Automated by dependency-updates.yml*" >> pr-body.md

      - name: Create Pull Request
        if: env.NO_UPDATES == 'false'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): Update Rust dependencies"
          branch: automated/cargo-update-${{ github.run_number }}
          title: "chore(deps): Weekly Rust dependency updates"
          body-path: pr-body.md
          labels: |
            dependencies
            automated
          assignees: ${{ github.repository_owner }}
          draft: false
